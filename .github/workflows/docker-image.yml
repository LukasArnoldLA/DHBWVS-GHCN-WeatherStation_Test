name: Docker CI/CD mit GHCR (Debug-Modus)

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Repository auschecken
        uses: actions/checkout@v3

      - name: ğŸ› Debug GitHub Repository Info
        run: |
          echo "ğŸ” GitHub Actor: ${{ github.actor }}"
          echo "ğŸ” Repository Owner: ${{ github.repository_owner }}"
          echo "ğŸ” Repository Name: ${{ github.repository }}"
          echo "ğŸ” GitHub Token LÃ¤nge: ${#GITHUB_TOKEN}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”¨ Docker Build
        run: |
          IMAGE_NAME=ghcr.io/${{ github.repository_owner }}/myapp:latest
          echo "ğŸ› ï¸ Bauen des Docker-Images: $IMAGE_NAME"
          docker build -t $IMAGE_NAME .

      - name: ğŸ”‘ GitHub Container Registry Login (mit GITHUB_TOKEN)
        run: |
          echo "ğŸ”‘ Versuche Login bei GHCR..."
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          echo "âœ… Login erfolgreich!"

      - name: ğŸš€ Docker Image Tagging & Push
        run: |
          IMAGE_NAME=ghcr.io/${{ github.repository_owner }}/myapp:latest
          echo "ğŸš€ Pushe Docker-Image: $IMAGE_NAME"
          docker push $IMAGE_NAME

      - name: ğŸ› ï¸ Debug Docker Images Liste
        run: docker images

      - name: ğŸ› ï¸ Debug Liste der GHCR-Pakete
        run: |
          echo "ğŸ” ÃœberprÃ¼fe GHCR-Pakete fÃ¼r ${{ github.repository_owner }}..."
          curl -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/users/${{ github.repository_owner }}/packages?package_type=container | jq
